name: Package NextCloud Server

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  package-code:
    runs-on: arc-runner-nc-fork

    steps:
      - name: Install Git
        run: |
          if ! command -v git &> /dev/null
          then
            echo "Git not found, installing..."
            sudo apt-get update
            sudo apt-get install -y git
          else
            echo "Git is already installed"
          fi

      - name: Install Docker
        run: |
          if ! command -v docker &> /dev/null
          then
            echo "Docker not found, installing..."
            sudo apt-get update
            sudo apt-get install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker $USER
          else
            echo "Docker is already installed"
            sudo systemctl start docker
          fi
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: IONOS-Productivity/nc-server
          ref: master

      - name: Package Code
        run: |
          mkdir -p /tmp/nc-server
          cp -r . /tmp/nc-server
          cd /tmp/nc-server
          tar -czvf /tmp/nc-server.tar.gz .
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nc-server-package
          path: /tmp/nc-server.tar.gz

      - name: Build Docker Image
        run: |
          cd /tmp/nc-server/.devcontainer
          docker build --network host -t muhali/nextcloud:latest .

      - name: Login to Harbor
        run: |
          echo ${{ secrets.HARBOR_PASSWORD }} | docker login reg.1u1.it -u ${{ secrets.HARBOR_USERNAME }} --password-stdin

      - name: Push Docker Image to Harbor
        run: |
          docker tag muhali/nextcloud:latest reg.1u1.it/nc/nextcloud:latest
          docker push reg.1u1.it/nc/nextcloud:latest
